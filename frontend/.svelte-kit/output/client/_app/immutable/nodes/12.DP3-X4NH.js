import"../chunks/DsnmJJEf.js";import"../chunks/2J32lFCu.js";import{o as aa,a as g,e as D}from"../chunks/D5sqcERo.js";import{at as ta,au as Se,av as sa,aq as y,aw as A,a as p,ax as oa,b as e,r as ia,s as m,W as T,ay as ra,az as o,ar as s,as as t,u as i,f as Ge,aA as oe,aB as ie,c as la,aC as ca}from"../chunks/DdWuALZu.js";import{i as z}from"../chunks/DNIL3y1X.js";import{e as X,i as Y}from"../chunks/qLEJnVdX.js";import{h as na}from"../chunks/CgsUcASs.js";import{b as re}from"../chunks/pQeqK__H.js";import{p as va}from"../chunks/CdEA5IGF.js";import{i as da}from"../chunks/-w5iKcy_.js";import{s as ha,a as R}from"../chunks/B3jtdlFh.js";import{g as ua}from"../chunks/C07Td5iz.js";import{a as le,b as M,v as we,c as ke,t as Ee,d as Ve,e as _a,f as ma,g as Z,h as pa}from"../chunks/3qLZv7Rd.js";import{p as Oe,m as ya,a as fa,b as ce,c as ga,d as ba}from"../chunks/y7-MpCW8.js";var $a=y('<button class="ghost svelte-7aymhh">Cancelar edición</button>'),Ca=y('<button class="primary svelte-7aymhh"> </button>'),xa=y("<!> <!>",1),Aa=y("<option> </option>"),Sa=y("<option> </option>"),wa=y("<option> </option>"),ka=y("<option> </option>"),Ea=y('<section class="panel svelte-7aymhh"><div class="panel-head svelte-7aymhh"><div><p class="label svelte-7aymhh">Formulario</p> <h2 class="svelte-7aymhh"> </h2></div> <button class="ghost svelte-7aymhh">Cerrar</button></div> <form class="form-grid svelte-7aymhh"><label class="field svelte-7aymhh"><span>Vehículo</span> <select class="svelte-7aymhh"><option>Seleccionar</option><!></select></label> <label class="field svelte-7aymhh"><span>Conductor</span> <select class="svelte-7aymhh"><option>Seleccionar</option><!></select></label> <label class="field svelte-7aymhh"><span>Cliente</span> <select class="svelte-7aymhh"><option>Seleccionar</option><!></select></label> <label class="field svelte-7aymhh"><span>Trayecto</span> <select class="svelte-7aymhh"><option>Seleccionar</option><!></select></label> <div class="form-actions svelte-7aymhh"><button type="submit" class="primary svelte-7aymhh"> </button> <button type="button" class="ghost svelte-7aymhh">Cancelar</button></div></form></section>'),Va=y('<div class="loading svelte-7aymhh"><div class="spinner svelte-7aymhh"></div> <p>Cargando asignaciones...</p></div>'),Na=y('<div class="empty svelte-7aymhh"><p>No hay asignaciones registradas.</p></div>'),Da=y('<button class="outline svelte-7aymhh">Editar</button>'),Ta=y('<button class="danger svelte-7aymhh">Desasignar</button>'),za=y('<tr class="svelte-7aymhh"><td class="svelte-7aymhh"> </td><td class="svelte-7aymhh"> </td><td class="svelte-7aymhh"> </td><td class="svelte-7aymhh"> </td><td class="svelte-7aymhh"> </td><td class="actions svelte-7aymhh"><!> <!></td></tr>'),Ma=y('<div class="table-wrap svelte-7aymhh"><table class="svelte-7aymhh"><thead class="svelte-7aymhh"><tr class="svelte-7aymhh"><th class="svelte-7aymhh">Vehículo</th><th class="svelte-7aymhh">Conductor</th><th class="svelte-7aymhh">Cliente</th><th class="svelte-7aymhh">Trayecto</th><th class="svelte-7aymhh">Fecha</th><th class="svelte-7aymhh"></th></tr></thead><tbody class="svelte-7aymhh"></tbody></table></div>'),Fa=y('<div class="modal-backdrop svelte-7aymhh"><div class="modal svelte-7aymhh"><p class="label svelte-7aymhh">Confirmar</p> <h3 class="svelte-7aymhh">¿Desasignar ruta?</h3> <p class="lede svelte-7aymhh">Se liberará <strong> </strong>.</p> <div class="modal-actions svelte-7aymhh"><button class="ghost svelte-7aymhh">Cancelar</button> <button class="danger svelte-7aymhh">Confirmar</button></div></div></div>'),Ga=y('<div class="page-shell svelte-7aymhh"><div class="bg-shape shape-a svelte-7aymhh" aria-hidden="true"></div> <div class="bg-shape shape-b svelte-7aymhh" aria-hidden="true"></div> <section class="hero svelte-7aymhh"><div class="hero-text svelte-7aymhh"><p class="eyebrow svelte-7aymhh">Operaciones</p> <h1 class="svelte-7aymhh">Gestión de Asignaciones</h1> <p class="lede svelte-7aymhh">Coordina rutas, vehículos y conductores con control visual.</p> <div class="chips svelte-7aymhh"><span class="chip success svelte-7aymhh"> </span> <span class="chip muted svelte-7aymhh"> </span></div></div> <div class="hero-actions svelte-7aymhh"><!></div></section> <!> <section class="panel svelte-7aymhh"><div class="panel-head svelte-7aymhh"><div><p class="label svelte-7aymhh">Listado</p> <h2 class="svelte-7aymhh">Asignaciones</h2></div></div> <!></section> <!></div>');function Xa(Le,je){ta(je,!1);const Ne=()=>R(ya,"$modulosConfig",I),V=()=>R(le,"$asignaciones",I),ne=()=>R(we,"$vehiculos",I),ve=()=>R(ke,"$conductores",I),de=()=>R(Ve,"$clientes",I),he=()=>R(Ee,"$trayectos",I),[I,qe]=ha(),ue=T(),U=T();let F=T(!1),N=T({open:!1,id:null,label:""}),S=T(null),c=T({id_vehiculo:"",id_conductor:"",id_trayecto:"",id_cliente:""});const ee="asignaciones";let _e=T(!1),ae=T(!1),De=T(!1);aa(async()=>{if(!fa(ee)){M("No tienes acceso al módulo Asignaciones","error"),ua("/");return}await me()});async function me(){try{const a=ce("vehiculos","ver"),d=ce("conductores","ver"),b=ce("trayectos","ver"),$=ce("clientes","ver");a||we.update(r=>({...r,items:[]})),d||ke.update(r=>({...r,items:[]})),b||Ee.update(r=>({...r,items:[]})),$||Ve.update(r=>({...r,items:[]}));const f=[];a&&f.push(_a.listar().then(r=>{we.update(x=>({...x,items:r.vehiculos||[]}))})),d&&f.push(ma.listar().then(r=>{ke.update(x=>({...x,items:r.conductores||[]}))})),b&&f.push(Z.listar().then(r=>{Ee.update(x=>({...x,items:r.trayectos||[]}))})),$&&f.push(pa.listar().then(r=>{Ve.update(x=>({...x,items:r.clientes||[]}))}));const h=(await Promise.allSettled(f)).filter(r=>r.status==="rejected");h.length&&(console.warn("Algunos catálogos no se pudieron cargar (permisos o error):",h),M("Algunos catálogos no se pudieron cargar por permisos.","warning")),le.update(r=>({...r,loading:!0}));const _=await Z.listarAsignaciones();le.update(r=>({...r,items:_.asignaciones||[],loading:!1}))}catch(a){le.update(d=>({...d,loading:!1})),M(a.message,"error")}}async function Be(){if(!e(c).id_vehiculo||!e(c).id_conductor||!e(c).id_trayecto||!e(c).id_cliente){M("Completa todos los campos","warning");return}const a={id_vehiculo:Number(e(c).id_vehiculo),id_conductor:Number(e(c).id_conductor),id_trayecto:Number(e(c).id_trayecto),id_cliente:Number(e(c).id_cliente)};try{e(S)?(await Z.actualizarAsignacion(e(S),a),M("Asignación actualizada","success")):(await Z.asignarTrayecto(a),M("Asignación creada","success")),m(c,{id_vehiculo:"",id_conductor:"",id_trayecto:"",id_cliente:""}),m(S,null),m(F,!1),await me()}catch(d){M(d.message,"error")}}function Ie(a){m(S,a.id_asignacion||a.id),m(c,{id_vehiculo:a.id_vehiculo?.toString()||"",id_conductor:a.id_conductor?.toString()||"",id_trayecto:a.id_trayecto?.toString()||"",id_cliente:a.id_cliente?.toString()||""}),m(F,!0)}function pe(){m(c,{id_vehiculo:"",id_conductor:"",id_trayecto:"",id_cliente:""}),m(S,null),m(F,!1)}function Pe(a){m(N,{open:!0,id:a.id_asignacion||a.id,label:`${a.vehiculo_placa||"Vehículo"} → ${a.trayecto_destino||""}`})}async function Re(){if(e(N).id)try{await Z.desasignarTrayecto(e(N).id),M("Asignación eliminada","success"),m(N,{open:!1,id:null,label:""}),await me()}catch(a){M(a.message,"error")}}Se(()=>Ne(),()=>{m(ue,Ne())}),Se(()=>(e(ue),Oe),()=>{e(ue),m(_e,ga(ee)),m(ae,ba(ee)),m(De,Oe(ee))}),Se(()=>V(),()=>{m(U,{total:V().items.length,vehiculos:new Set(V().items.map(a=>a.id_vehiculo)).size})}),sa(),da();var ye=Ga();na("7aymhh",a=>{ia(()=>{ra.title="Gestión de Asignaciones - TransConecta"})});var fe=o(s(ye),4),ge=s(fe),Te=o(s(ge),6),be=s(Te),Ue=s(be);t(be);var ze=o(be,2),We=s(ze);t(ze),t(Te),t(ge);var Me=o(ge,2),He=s(Me);{var Je=a=>{var d=xa(),b=Ge(d);{var $=h=>{var _=$a();D("click",_,pe),p(h,_)};z(b,h=>{e(S)&&h($)})}var f=o(b,2);{var C=h=>{var _=Ca(),r=s(_,!0);t(_),A(()=>g(r,e(F)?"Cerrar":e(S)?"Editar asignación":"+ Nueva asignación")),D("click",_,()=>m(F,!e(F))),p(h,_)};z(f,h=>{(e(S)&&e(ae)||!e(S)&&e(_e))&&h(C)})}p(a,d)};z(He,a=>{(e(_e)||e(ae))&&a(Je)})}t(Me),t(fe);var Fe=o(fe,2);{var Ke=a=>{var d=Ea(),b=s(d),$=s(b),f=o(s($),2),C=s(f,!0);t(f),t($);var h=o($,2);t(b);var _=o(b,2),r=s(_),x=o(s(r),2);A(()=>{e(c),oe(()=>{ne()})});var n=s(x);n.value=n.__value="";var W=o(n);X(W,1,()=>(ne(),i(()=>ne().items)),Y,(u,l)=>{var v=Aa(),B=s(v);t(v);var k={};A(E=>{g(B,`${e(l),i(()=>e(l).placa)??""} · ${e(l),i(()=>e(l).marca)??""} ${e(l),i(()=>e(l).modelo)??""}`),k!==(k=E)&&(v.value=(v.__value=E)??"")},[()=>(e(l),i(()=>String(e(l).id_vehiculo)))]),p(u,v)}),t(x),t(r);var G=o(r,2),H=o(s(G),2);A(()=>{e(c),oe(()=>{ve()})});var O=s(H);O.value=O.__value="";var Ce=o(O);X(Ce,1,()=>(ve(),i(()=>ve().items)),Y,(u,l)=>{var v=Sa(),B=s(v);t(v);var k={};A(E=>{g(B,`${e(l),i(()=>e(l).nombre)??""} (${e(l),i(()=>e(l).cedula)??""})`),k!==(k=E)&&(v.value=(v.__value=E)??"")},[()=>(e(l),i(()=>String(e(l).id_conductor)))]),p(u,v)}),t(H),t(G);var L=o(G,2),J=o(s(L),2);A(()=>{e(c),oe(()=>{de()})});var j=s(J);j.value=j.__value="";var xe=o(j);X(xe,1,()=>(de(),i(()=>de().items)),Y,(u,l)=>{var v=wa(),B=s(v,!0);t(v);var k={};A(E=>{g(B,(e(l),i(()=>e(l).nombre))),k!==(k=E)&&(v.value=(v.__value=E)??"")},[()=>(e(l),i(()=>String(e(l).id_cliente)))]),p(u,v)}),t(J),t(L);var q=o(L,2),K=o(s(q),2);A(()=>{e(c),oe(()=>{he()})});var P=s(K);P.value=P.__value="";var te=o(P);X(te,1,()=>(he(),i(()=>he().items)),Y,(u,l)=>{var v=ka(),B=s(v);t(v);var k={};A(E=>{g(B,`${e(l),i(()=>e(l).origen)??""} → ${e(l),i(()=>e(l).destino)??""} (${e(l),i(()=>e(l).distancia_km)??""} km)`),k!==(k=E)&&(v.value=(v.__value=E)??"")},[()=>(e(l),i(()=>String(e(l).id_trayecto)))]),p(u,v)}),t(K),t(q);var se=o(q,2),Q=s(se),Ae=s(Q,!0);t(Q);var w=o(Q,2);t(se),t(_),t(d),A(()=>{g(C,e(S)?"Editar asignación":"Crear asignación"),g(Ae,e(S)?"Guardar cambios":"Asignar")}),D("click",h,pe),re(x,()=>e(c).id_vehiculo,u=>ie(c,e(c).id_vehiculo=u)),re(H,()=>e(c).id_conductor,u=>ie(c,e(c).id_conductor=u)),re(J,()=>e(c).id_cliente,u=>ie(c,e(c).id_cliente=u)),re(K,()=>e(c).id_trayecto,u=>ie(c,e(c).id_trayecto=u)),D("click",w,pe),D("submit",_,va(Be)),p(a,d)};z(Fe,a=>{e(F)&&a(Ke)})}var $e=o(Fe,2),Qe=o(s($e),2);{var Xe=a=>{var d=Va();p(a,d)},Ye=a=>{var d=la(),b=Ge(d);{var $=C=>{var h=Na();p(C,h)},f=C=>{var h=Ma(),_=s(h),r=o(s(_));X(r,5,()=>(V(),i(()=>V().items)),Y,(x,n)=>{var W=za(),G=s(W),H=s(G);t(G);var O=o(G),Ce=s(O);t(O);var L=o(O),J=s(L,!0);t(L);var j=o(L),xe=s(j);t(j);var q=o(j),K=s(q,!0);t(q);var P=o(q),te=s(P);{var se=w=>{var u=Da();D("click",u,()=>Ie(e(n))),p(w,u)};z(te,w=>{e(ae)&&w(se)})}var Q=o(te,2);{var Ae=w=>{var u=Ta();D("click",u,()=>Pe(e(n))),p(w,u)};z(Q,w=>{e(De)&&w(Ae)})}t(P),t(W),A(w=>{g(H,`${e(n),i(()=>e(n).vehiculo_placa||"—")??""} · ${e(n),i(()=>e(n).vehiculo_marca||"")??""} ${e(n),i(()=>e(n).vehiculo_modelo||"")??""}`),g(Ce,`${e(n),i(()=>e(n).conductor_nombre||"—")??""} (${e(n),i(()=>e(n).conductor_cedula||"—")??""})`),g(J,(e(n),i(()=>e(n).cliente_nombre||"—"))),g(xe,`${e(n),i(()=>e(n).trayecto_origen||"—")??""} → ${e(n),i(()=>e(n).trayecto_destino||"—")??""}`),g(K,w)},[()=>(e(n),i(()=>e(n).fecha_asignacion?e(n).fecha_asignacion.substring(0,10):"—"))]),p(x,W)}),t(r),t(_),t(h),p(C,h)};z(b,C=>{V(),i(()=>V().items.length===0)?C($):C(f,!1)},!0)}p(a,d)};z(Qe,a=>{V(),i(()=>V().loading)?a(Xe):a(Ye,!1)})}t($e);var Ze=o($e,2);{var ea=a=>{var d=Fa(),b=s(d),$=o(s(b),4),f=o(s($)),C=s(f,!0);t(f),ca(),t($);var h=o($,2),_=s(h),r=o(_,2);t(h),t(b),t(d),A(()=>g(C,(e(N),i(()=>e(N).label)))),D("click",_,()=>m(N,{open:!1,id:null,label:""})),D("click",r,Re),p(a,d)};z(Ze,a=>{e(N),i(()=>e(N).open)&&a(ea)})}t(ye),A(()=>{g(Ue,`${e(U),i(()=>e(U).total)??""} asignaciones`),g(We,`${e(U),i(()=>e(U).vehiculos)??""} vehículos`)}),p(Le,ye),oa(),qe()}export{Xa as component};
